<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Herbstberg â€” Gruppenplaner (live)</title>
<style>
  :root {
    --bg: #ffffff;
    --card: rgba(255,255,255,0.85);
    --muted: #555;
    --accent: #d23ea6;   /* Pink-Violett */
    --accent2: #0095ff;  /* Blau */
    --ok: #16a34a;
  }
  *{box-sizing:border-box}
  body{
    font-family:system-ui, Helvetica, Arial;
    background: linear-gradient(180deg, #0095ff, #8364e8, #d23ea6);
    background-attachment: fixed;
    background-size: cover;
    margin:0; padding:18px; color:#0f172a; position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background: rgba(255,255,255,.55);
    backdrop-filter: blur(6px);
    z-index:-1;
  }
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
  h1{
    margin:0;font-size:22px;
    background:linear-gradient(90deg,#0095ff,#d23ea6);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .card{
    background:var(--card); border-radius:16px; padding:16px; margin-bottom:16px;
    box-shadow:0 4px 20px rgba(0,0,0,.08); backdrop-filter: blur(5px);
  }
  .row{display:flex;gap:8px;align-items:center}
  input,select,textarea{padding:8px 10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button{
    padding:8px 14px;border-radius:8px;border:none;font-size:14px;cursor:pointer;transition:.2s;
    background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#fff; font-weight:500;
    box-shadow:0 3px 10px rgba(210,62,166,.25);
  }
  button:hover{opacity:.9; transform:translateY(-1px); box-shadow:0 5px 12px rgba(210,62,166,.35)}
  .muted{color:var(--muted);font-size:13px}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .item{
    display:flex; align-items:center; gap:8px;
    border:1px solid rgba(0,0,0,.05); background:rgba(255,255,255,.6);
    padding:10px; border-radius:10px; transition:background .2s;
  }
  .item:hover{background:rgba(255,255,255,.8)}
  .pill{background:rgba(255,255,255,.7);padding:4px 10px;border-radius:999px;font-size:13px;border:1px solid rgba(0,0,0,.06)}
  .small{font-size:13px;color:var(--muted)}
  .right{margin-left:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:760px){.grid{grid-template-columns:1fr}}
  .participants{display:flex;gap:8px;flex-wrap:wrap}
  .avatar{
    width:38px;height:38px;border-radius:50%;
    display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:600;
    background:linear-gradient(135deg,var(--accent2),var(--accent)); box-shadow:0 2px 8px rgba(0,0,0,.2);
  }
  /* Beteiligung / Avatare */
  .mini{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .avatar-xs{
    width:22px;height:22px;border-radius:50%;
    display:inline-flex;align-items:center;justify-content:center;
    font-size:12px;color:#fff;background:linear-gradient(135deg,var(--accent2),var(--accent));
    box-shadow:0 1px 4px rgba(0,0,0,.15);
  }
  .status-dot{width:10px;height:10px;border-radius:50%;margin-top:2px;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.2)}
  .dot-ok{background:#10b981}.dot-warn{background:#f59e0b}.dot-off{background:#cbd5e1}
  .badge{
    font-size:12px;padding:2px 8px;border-radius:999px;
    background:rgba(255,127,80,.15);border:1px solid rgba(255,127,80,.3);color:#b45309;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Herbstberg â€” Gruppenplaner</h1>
      <div class="small" id="statusText">Live-Sync wird aufgebaut â€¦</div>
    </div>
    <div class="right">
      <button id="exportBtn">Export (WhatsApp)</button>
      <button id="clearBtn" style="margin-left:8px;background:#ef4444">Nur dieses GerÃ¤t zurÃ¼cksetzen</button>
    </div>
  </header>

  <!-- Filter-Leiste -->
  <div class="card" id="meFilterCard" style="margin-bottom:14px;display:flex;align-items:center;gap:10px">
    <div class="small" id="meInfoText">Nicht angemeldet â€“ erst Namen setzen</div>
    <label style="display:flex;align-items:center;gap:6px;margin-left:auto;cursor:pointer;">
      <input type="checkbox" id="missingOnly" />
      <span class="small">Nur anzeigen, wo ich noch nicht mitgemacht hab</span>
    </label>
  </div>

  <!-- Nutzer / Session -->
  <section class="card" id="userCard">
    <div class="row">
      <div>
        <div class="small">Dein Name</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div id="meAvatar" class="avatar">â€“</div>
          <div id="meName" class="pill">Nicht gesetzt</div>
        </div>
      </div>
      <div class="right">
        <input id="nameInput" placeholder="Name eingeben" />
        <button id="setName">Setzen</button>
      </div>
    </div>
    <div style="margin-top:10px" class="small">Alle Teilnehmer</div>
    <div id="participants" class="participants" style="margin-top:8px"></div>
  </section>

  <div class="grid">
    <!-- Listen / Aufgaben -->
    <section class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <div><strong>Listen & Aufgaben</strong></div>
        <div class="small">Erstelle Listen, andere kÃ¶nnen sich eintragen</div>
      </div>
      <div style="margin-top:8px" class="row">
        <input id="listTitle" placeholder="Listentitel (z. B. Packliste KÃ¼che)" />
        <button id="addList">Liste erstellen</button>
      </div>
      <div id="lists" class="list" style="margin-top:12px"></div>
    </section>

    <!-- Umfragen -->
    <section class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <div><strong>Umfragen</strong></div>
        <div class="small">Mehrfachauswahl mÃ¶glich</div>
      </div>
      <div style="margin-top:8px" class="row">
        <input id="pollTitle" placeholder="Frage (z. B. Raclette oder Grillen?)" />
      </div>
      <div style="margin-top:8px" class="row">
        <input id="pollOpt" placeholder="Option hinzufÃ¼gen (Enter)" />
        <button id="createPoll">Umfrage erstellen</button>
      </div>
      <div id="polls" class="list" style="margin-top:12px"></div>
    </section>

    <!-- Ausgaben -->
    <section class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <div><strong>Ausgaben</strong></div>
        <div class="small">Wer hat bezahlt, wer ist beteiligt</div>
      </div>
      <div style="margin-top:8px" class="row">
        <input id="expenseTitle" placeholder="z. B. GetrÃ¤nke" />
        <input id="expenseAmount" placeholder="Betrag â‚¬" style="width:110px" />
      </div>
      <div style="margin-top:8px" class="row">
        <select id="expensePayer"></select>
        <button id="addExpense">Eintragen</button>
      </div>
      <div id="expenses" class="list" style="margin-top:12px"></div>
      <div class="row" style="margin-top:10px">
        <button id="calcSettle">Abrechnung berechnen</button>
      </div>
      <div id="settlement" class="list" style="margin-top:10px"></div>
    </section>

    <!-- Hilfe -->
    <section class="card">
      <strong>Kurzanleitung</strong>
      <ol style="margin-top:8px">
        <li>Oben Namen setzen</li>
        <li>Listen/Umfragen erstellen</li>
        <li>Schalter nutzen: â€žNur anzeigen, wo ich noch nicht mitgemacht habâ€œ</li>
      </ol>
      <div style="margin-top:10px" class="small">Daten werden in Firestore geteilt Â· lÃ¤uft auch lokal weiter.</div>
    </section>
  </div>
</div>

<!-- Firebase + App-Code -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* deine Firebase-Daten */
const firebaseConfig = {
  apiKey: "AIzaSyCrt9Sh5yHPeccMh0bgr-MmLb1vq8CB_xw",
  authDomain: "herbstberg-13d85.firebaseapp.com",
  projectId: "herbstberg-13d85",
  storageBucket: "herbstberg-13d85.firebasestorage.app",
  messagingSenderId: "944096618824",
  appId: "1:944096618824:web:2ce2eee51727a1f29eab7d"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ein Raum = ein Dokument */
const ROOM_ID = "winterberg";  // kannst du bei Bedarf Ã¤ndern
const roomRef = doc(db, "rooms", ROOM_ID);

function id(){ return Math.random().toString(36).slice(2,9) }

/* DOM-Refs */
const meAvatar=document.getElementById('meAvatar')
const meName=document.getElementById('meName')
const nameInput=document.getElementById('nameInput')
const setNameBtn=document.getElementById('setName')
const participantsEl=document.getElementById('participants')
const addListBtn=document.getElementById('addList')
const listTitleInput=document.getElementById('listTitle')
const listsEl=document.getElementById('lists')
const pollTitleInput=document.getElementById('pollTitle')
const pollOptInput=document.getElementById('pollOpt')
const createPollBtn=document.getElementById('createPoll')
const pollsEl=document.getElementById('polls')
const expenseTitle=document.getElementById('expenseTitle')
const expenseAmount=document.getElementById('expenseAmount')
const expensePayer=document.getElementById('expensePayer')
const addExpenseBtn=document.getElementById('addExpense')
const expensesEl=document.getElementById('expenses')
const exportBtn=document.getElementById('exportBtn')
const clearBtn=document.getElementById('clearBtn')
const settlementEl=document.getElementById('settlement')
const calcSettleBtn=document.getElementById('calcSettle')
const statusText=document.getElementById('statusText')
const missingOnly=document.getElementById('missingOnly')
const meInfoText=document.getElementById('meInfoText')

/* lokaler Speicher */
const LSKEY='hb_cache_v1'
const LOCAL_ME_KEY='hb_me_v1'

let store = {
  participants: [],
  lists: [],
  polls: [],
  expenses: []
}
let me = loadMe()         // <- bleibt lokal
let ready = false
let showMissingOnly = false
const clientId = id()

function loadMe(){
  try{
    const s = localStorage.getItem(LOCAL_ME_KEY)
    if(s) return JSON.parse(s)
  }catch{}
  return null
}
function saveMe(){
  localStorage.setItem(LOCAL_ME_KEY, JSON.stringify(me))
}
function saveLocalStore(){
  localStorage.setItem(LSKEY, JSON.stringify(store))
}
function loadLocalStore(){
  try{
    const s = localStorage.getItem(LSKEY)
    if(s) store = JSON.parse(s)
  }catch{}
}

/* Teilnehmer aus Cloud mit lokalem me zusammenfÃ¼hren */
function mergeParticipants(cloudParticipants){
  const merged = [...cloudParticipants]
  if(me){
    const exists = merged.some(p => p.id === me.id)
    if(!exists){
      merged.push({ id: me.id, name: me.name })
    }
  }
  return merged
}

/* Cloud laden */
async function loadFromCloud(){
  try{
    const snap = await getDoc(roomRef)
    if(snap.exists()){
      const cloud = snap.data().data || {}
      store.lists    = cloud.lists    || []
      store.polls    = cloud.polls    || []
      store.expenses = cloud.expenses || []
      store.participants = mergeParticipants(cloud.participants || [])
    } else {
      // erste Initialisierung
      store.participants = me ? [{id: me.id, name: me.name}] : []
      await setDoc(roomRef, { data: store, updatedAt: Date.now(), by: clientId })
    }
    saveLocalStore()
    ready = true
    renderAll()
    statusText.textContent = "Live-Sync aktiv â€¢ Daten werden in der Cloud geteilt"
  } catch(e){
    console.error(e)
    statusText.textContent = "Cloud nicht erreichbar â€“ arbeite lokal"
    loadLocalStore()
    ready = true
    renderAll()
  }
}

/* Live-Updates aus der Cloud: mergen, nicht Ã¼berschreiben */
onSnapshot(roomRef, (snap)=>{
  if(!snap.exists()) return
  const cloud = snap.data().data || {}
  store.lists    = cloud.lists    || []
  store.polls    = cloud.polls    || []
  store.expenses = cloud.expenses || []
  store.participants = mergeParticipants(cloud.participants || [])
  saveLocalStore()
  if(ready) renderAll()
})

/* Nur die gemeinsamen Daten speichern â€“ NICHT me */
let saveTimer = null
function saveToCloud(){
  saveLocalStore()
  if(saveTimer) clearTimeout(saveTimer)
  saveTimer = setTimeout(async ()=>{
    try{
      await setDoc(roomRef, {
        data: {
          participants: store.participants,
          lists: store.lists,
          polls: store.polls,
          expenses: store.expenses
        },
        updatedAt: Date.now(),
        by: clientId
      }, { merge: true })
    }catch(e){
      console.error(e)
      statusText.textContent = "Speichern fehlgeschlagen â€“ offline?"
    }
  }, 200)
}

/* Hilfsfunktionen */
function miniAvatars(ids){
  const wrap=document.createElement('div'); wrap.className='mini';
  ids.slice(0,10).forEach(uid=>{
    const p=store.participants.find(x=>x.id===uid); if(!p) return;
    const el=document.createElement('div'); el.className='avatar-xs'; el.title=p.name;
    el.textContent=(p.name||'?').slice(0,1).toUpperCase();
    wrap.appendChild(el);
  });
  return wrap;
}
function userParticipation(uid){
  let inLists=false,inPolls=false,inExpenses=false;
  for(const L of store.lists){ if(L.items && L.items.some(it=>it.byIDs && it.byIDs.includes(uid))){ inLists=true; break; } }
  for(const P of store.polls){ if(P.options && P.options.some(o=>o.votes && o.votes.includes(uid))){ inPolls=true; break; } }
  for(const E of store.expenses){ if(E.payerId===uid || (E.participants||[]).includes(uid)){ inExpenses=true; break; } }
  const score=[inLists,inPolls,inExpenses].filter(Boolean).length;
  return {score};
}
function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]) }
function ensureMe(){
  if(!me){
    const n=prompt('Wie heiÃŸt du?'); if(!n) return false;
    me = { id: id(), name: n }
    saveMe()
    store.participants.push({ id: me.id, name: me.name })
    saveToCloud()
  }
  return true;
}

/* Events */
setNameBtn.onclick = () => {
  const name = nameInput.value.trim()
  if(!name) return alert('Bitte Namen eingeben')
  if(!me){
    me = { id: id(), name }
  } else {
    me.name = name
  }
  saveMe()

  const idx = store.participants.findIndex(p => p.id === me.id)
  if(idx >= 0) store.participants[idx].name = me.name
  else store.participants.push({ id: me.id, name: me.name })

  nameInput.value = ''
  saveToCloud()
  renderAll()
}

missingOnly.onchange = () => {
  showMissingOnly = missingOnly.checked
  renderAll()
}

addListBtn.onclick = () => {
  const t=listTitleInput.value.trim(); if(!t) return alert('Bitte Listentitel eingeben')
  store.lists.unshift({id:id(),title:t,items:[]})
  listTitleInput.value=''
  saveToCloud()
  renderAll()
}

createPollBtn.onclick = () => {
  const q=pollTitleInput.value.trim(), opt=pollOptInput.value.trim()
  if(!q || !opt) return alert('Frage und mindestens eine Option nÃ¶tig')
  store.polls.unshift({id:id(),question:q,options:[{id:id(),text:opt,votes:[]}]})
  pollTitleInput.value=''; pollOptInput.value=''
  saveToCloud(); renderAll()
}

addExpenseBtn.onclick = () => {
  const t=expenseTitle.value.trim()
  const a=parseFloat((expenseAmount.value||'').replace(',','.'))
  const payer=expensePayer.value
  if(!t || isNaN(a) || !payer) return alert('Bitte Titel, Betrag und Zahler wÃ¤hlen')
  store.expenses.unshift({id:id(),title:t,amount:a,payerId:payer,participants:[...store.participants.map(p=>p.id)]})
  expenseTitle.value=''; expenseAmount.value=''
  saveToCloud(); renderAll()
}

exportBtn.onclick = () => {
  const txt = buildExportText()
  prompt('Kopiere den Text und fÃ¼ge ihn in WhatsApp ein:', txt)
}

clearBtn.onclick = () => {
  if(confirm('Nur diesen Browser zurÃ¼cksetzen? (Cloud-Daten bleiben)')){
    localStorage.removeItem(LOCAL_ME_KEY)
    localStorage.removeItem(LSKEY)
    location.reload()
  }
}

calcSettleBtn.onclick = () => {
  const bal=calcBalances(), tx=settleTransactions(bal)
  settlementEl.innerHTML=''
  if(tx.length===0){
    const d=document.createElement('div'); d.className='badge'; d.textContent='Alles ausgeglichen ðŸŽ‰'
    settlementEl.appendChild(d); return
  }
  tx.forEach(t=>{
    const from=(store.participants.find(p=>p.id===t.from)||{name:'?'}).name
    const to=(store.participants.find(p=>p.id===t.to)||{name:'?'}).name
    const row=document.createElement('div'); row.className='item'
    row.innerHTML=`<div style="flex:1"><strong>${from}</strong> âžœ <strong>${to}</strong></div><div class="badge">${t.amount.toFixed(2)} â‚¬</div>`
    settlementEl.appendChild(row)
  })
}

/* Abrechnung */
function calcBalances(){
  const bal=Object.fromEntries(store.participants.map(p=>[p.id,0]))
  for(const E of store.expenses){
    const participants=(E.participants && E.participants.length)?E.participants:store.participants.map(p=>p.id)
    const share=E.amount/participants.length
    participants.forEach(uid=> bal[uid]-=share)
    bal[E.payerId]=(bal[E.payerId]||0)+E.amount
  }
  return bal
}
function settleTransactions(bal){
  const debtors=[], creditors=[]
  for(const [uid,amt] of Object.entries(bal)){
    if(amt<-0.005) debtors.push({uid,amt})
    else if(amt>0.005) creditors.push({uid,amt})
  }
  debtors.sort((a,b)=>a.amt-b.amt)
  creditors.sort((a,b)=>b.amt-a.amt)
  const tx=[]
  let i=0,j=0
  while(i<debtors.length && j<creditors.length){
    const d=debtors[i], c=creditors[j]
    const pay=Math.min(-d.amt, c.amt)
    tx.push({from:d.uid,to:c.uid,amount:pay})
    d.amt+=pay; c.amt-=pay
    if(Math.abs(d.amt)<0.005) i++
    if(Math.abs(c.amt)<0.005) j++
  }
  return tx
}

/* Render */
function renderAll(){
  // oben: wer bin ich?
  if (me) {
    meInfoText.textContent = `Angemeldet als: ${me.name}`
    missingOnly.disabled = false
  } else {
    meInfoText.textContent = `Nicht angemeldet â€“ erst Namen setzen`
    missingOnly.checked = false
    missingOnly.disabled = true
    showMissingOnly = false
  }

  // Teilnehmer
  participantsEl.innerHTML=''
  for(const p of store.participants){
    const d=document.createElement('div')
    d.style.display='inline-flex'; d.style.flexDirection='column'; d.style.alignItems='center'; d.style.position='relative'
    const av=document.createElement('div'); av.className='avatar'; av.textContent=(p.name.split(' ')[0][0]||'?')
    const dot=document.createElement('div'); dot.className='status-dot'
    const part=userParticipation(p.id)
    dot.classList.add(part.score>=2?'dot-ok':(part.score===1?'dot-warn':'dot-off'))
    dot.style.marginTop='-10px'; dot.style.marginLeft='22px'; dot.style.position='relative'
    const nm=document.createElement('div'); nm.className='small'; nm.textContent=p.name
    d.appendChild(av); d.appendChild(dot); d.appendChild(nm)

    // jeder darf lÃ¶schen â€“ aber nicht sich selbst
    if (!me || p.id !== me.id) {
      const del = document.createElement('button')
      del.textContent = 'Ã—'
      del.style.position = 'absolute'
      del.style.top = '-6px'
      del.style.right = '-6px'
      del.style.width = '22px'
      del.style.height = '22px'
      del.style.borderRadius = '50%'
      del.style.border = 'none'
      del.style.background = '#f43f5e'
      del.style.color = 'white'
      del.style.fontSize = '14px'
      del.style.cursor = 'pointer'
      del.onclick = () => {
        if (!confirm(`Teilnehmer â€ž${p.name}â€œ wirklich entfernen?`)) return

        // 1. aus Teilnehmern
        store.participants = store.participants.filter(x => x.id !== p.id)
        // 2. aus Listen
        for (const L of store.lists) {
          for (const it of (L.items || [])) {
            it.byIDs = (it.byIDs || []).filter(id => id !== p.id)
          }
        }
        // 3. aus Umfragen
        for (const P of store.polls) {
          for (const o of (P.options || [])) {
            o.votes = (o.votes || []).filter(id => id !== p.id)
          }
        }
        // 4. aus Ausgaben
        for (const E of store.expenses) {
          E.participants = (E.participants || []).filter(id => id !== p.id)
          if (E.payerId === p.id) {
            const fallback = store.participants[0]
            E.payerId = fallback ? fallback.id : null
          }
        }
        saveToCloud()
        renderAll()
      }
      d.appendChild(del)
    }

    participantsEl.appendChild(d)
  }
  meAvatar.textContent = me ? (me.name.split(' ')[0][0]||'?') : 'â€“'
  meName.textContent   = me ? me.name : 'Nicht gesetzt'

  // Zahler
  expensePayer.innerHTML='<option value="">Zahler wÃ¤hlen</option>'
  for(const p of store.participants){
    const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; expensePayer.appendChild(o)
  }

  // Listen
  listsEl.innerHTML=''
  for(const L of store.lists){
    // hat ME hier teilgenommen?
    let meContributedHere = false
    if (me) {
      for (const it of (L.items || [])) {
        if (it.byIDs && it.byIDs.includes(me.id)) {
          meContributedHere = true
          break
        }
      }
    }
    // Filter: nur die, wo ich noch nicht drin bin
    if (showMissingOnly && me && meContributedHere) {
      continue
    }

    const box=document.createElement('div'); box.className='item'
    const title=document.createElement('div'); title.style.flex='1'
    title.innerHTML=`<strong>${escapeHtml(L.title)}</strong>`
    if (me && !meContributedHere) {
      const tag = document.createElement('span')
      tag.className='badge'
      tag.textContent='du fehlst hier'
      tag.style.marginLeft='6px'
      title.appendChild(tag)
    }

    const count=document.createElement('div'); count.className='small'
    const btnAddItem=document.createElement('button'); btnAddItem.textContent='Eintrag'
    btnAddItem.onclick=()=>{
      if(!ensureMe()) return
      const txt=prompt('Eintragstext (z. B. "Zewa")'); if(!txt) return
      if (!L.items) L.items = []
      L.items.unshift({id:id(),text:txt,byIDs:[me.id]}); saveToCloud(); renderAll()
    }
    const contributed=new Set()
    for(const it of (L.items || [])){ for(const u of (it.byIDs || [])){ contributed.add(u) } }
    const total=store.participants.length
    count.textContent=`${contributed.size}/${total} beteiligt`
    const avWrap=miniAvatars([...contributed])

    const mini=document.createElement('div'); mini.className='small'; mini.style.marginTop='6px'
    if(!L.items || L.items.length===0) mini.textContent='Noch keine EintrÃ¤ge'
    else{
      mini.innerHTML=L.items.map(it=>{
        const mine=me && (it.byIDs||[]).includes(me.id)
        const who=(it.byIDs||[]).map(id=> (store.participants.find(p=>p.id===id)||{name:'?'}).name.split(' ')[0]).join(', ')
        return `<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">
          <input type="checkbox" ${mine?'checked':''} data-listid="${L.id}" data-itemid="${it.id}" class="markChk"/>
          <div style="flex:1">${escapeHtml(it.text)} <span class="small" style="color:#94a3b8">(${who})</span></div>
        </div>`
      }).join('')
    }

    box.appendChild(title)
    const meta=document.createElement('div'); meta.style.display='flex'; meta.style.flexDirection='column'; meta.style.gap='6px'; meta.style.width='260px'
    meta.appendChild(count); meta.appendChild(avWrap); meta.appendChild(btnAddItem)
    box.appendChild(meta)
    const wrap=document.createElement('div'); wrap.style.width='100%'; wrap.appendChild(box)
    const container=document.createElement('div'); container.appendChild(wrap); container.appendChild(mini)
    listsEl.appendChild(container)
  }
  document.querySelectorAll('.markChk').forEach(chk=>{
    chk.onclick=()=>{
      if(!ensureMe()) return
      const listid=chk.dataset.listid, itemid=chk.dataset.itemid
      const L=store.lists.find(x=>x.id===listid); if(!L) return
      const it=L.items.find(x=>x.id===itemid); if(!it) return
      it.byIDs = it.byIDs || []
      if(it.byIDs.includes(me.id)) it.byIDs=it.byIDs.filter(x=>x!==me.id)
      else it.byIDs.push(me.id)
      saveToCloud(); renderAll()
    }
  })

  // Umfragen (Mehrfach)
  pollsEl.innerHTML=''
  for(const P of store.polls){
    // hat ME hier abgestimmt?
    let meVotedHere = false
    if (me) {
      for (const o of (P.options || [])) {
        if (o.votes && o.votes.includes(me.id)) {
          meVotedHere = true
          break
        }
      }
    }
    if (showMissingOnly && me && meVotedHere) {
      continue
    }

    const box=document.createElement('div'); box.className='item'
    const q=document.createElement('div'); q.style.flex='1'
    q.innerHTML=`<strong>${escapeHtml(P.question)}</strong>`
    if (me && !meVotedHere) {
      const tag=document.createElement('span')
      tag.className='badge'
      tag.textContent='du hast noch nicht abgestimmt'
      tag.style.marginLeft='6px'
      q.appendChild(tag)
    }
    const optPane=document.createElement('div'); optPane.style.width='280px'; optPane.style.display='flex'; optPane.style.flexDirection='column'; optPane.style.gap='6px'
    for(const o of (P.options || [])){
      const voted = me && (o.votes||[]).includes(me.id)
      const btn=document.createElement('button')
      btn.style.background= voted ? 'linear-gradient(90deg,#22c55e,#16a34a)' : '#ffffff'
      btn.style.color= voted ? '#fff' : '#0f172a'
      btn.style.border= voted ? 'none' : '1px solid #e5e7eb'
      btn.textContent = `${o.text} (${(o.votes||[]).length})${voted?' âœ“':''}`
      btn.onclick=()=>{
        if(!ensureMe()) return
        o.votes = o.votes || []
        if(o.votes.includes(me.id)) o.votes=o.votes.filter(x=>x!==me.id)
        else o.votes.push(me.id)
        saveToCloud(); renderAll()
      }
      optPane.appendChild(btn)
      const votersWrap=miniAvatars((o.votes||[]).slice())
      optPane.appendChild(votersWrap)
    }
    const addOptBtn=document.createElement('button'); addOptBtn.textContent='Option hinzufÃ¼gen'; addOptBtn.style.background='#efefef'; addOptBtn.style.color='#111'
    addOptBtn.onclick=()=>{ const t=prompt('Optionstext'); if(!t) return; P.options.push({id:id(),text:t,votes:[]}); saveToCloud(); renderAll() }
    optPane.appendChild(addOptBtn)
    box.appendChild(q); box.appendChild(optPane)
    pollsEl.appendChild(box)
  }

  // Ausgaben
  expensesEl.innerHTML=''
  for(const E of store.expenses){
    const box=document.createElement('div'); box.className='item'
    const left=document.createElement('div'); left.style.flex='1'
    left.innerHTML=`<strong>${escapeHtml(E.title)}</strong><div class="small">${E.amount.toFixed(2)} â‚¬</div>`
    const payerName=(store.participants.find(p=>p.id===E.payerId)||{name:'?'}).name
    const right=document.createElement('div'); right.style.minWidth='260px'; right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px'
    const who=document.createElement('div'); who.className='small'; who.textContent=`Bezahlt: ${payerName}`
    const parts=document.createElement('div'); parts.className='small'; parts.textContent=`Beteiligte: ${(E.participants||[]).length}`
    right.appendChild(who); right.appendChild(parts)
    box.appendChild(left); box.appendChild(right)
    expensesEl.appendChild(box)
  }
}

function buildExportText(){
  let out = `Herbstberg â€“ GruppenÃ¼bersicht\n\n`
  out += `Teilnehmer:\n` + store.participants.map(p=>`- ${p.name}`).join('\n') + '\n\n'
  out += `Listen:\n`
  for(const L of store.lists){
    out += `* ${L.title}\n`
    if(!L.items || L.items.length===0) out += `  (noch leer)\n`
    else for(const it of L.items){
      const who = (it.byIDs||[]).map(id=> (store.participants.find(p=>p.id===id)||{name:'?'}).name.split(' ')[0]).join(', ')
      out += `  - ${it.text} (${who})\n`
    }
  }
  out += `\nUmfragen (Mehrfachauswahl):\n`
  for(const P of store.polls){
    out += `* ${P.question}\n`
    for(const o of (P.options||[])) out += `  - ${o.text} (${(o.votes||[]).length})\n`
  }
  out += `\nAusgaben:\n`
  for(const E of store.expenses){
    const payer=(store.participants.find(p=>p.id===E.payerId)||{name:'?'}).name
    out += `* ${E.title} â€” ${E.amount.toFixed(2)} â‚¬ â€” bezahlt von ${payer}\n`
  }
  return out
}

/* Start */
loadLocalStore()
renderAll()
loadFromCloud()
</script>
</body>
</html>
